<%- include('../Layouts/adminHeader.ejs') %>
    <!-- End Navbar -->
    <div class="container-fluid py-4">
      <div class="row">
        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
          <div class="card">
            <div class="card-header p-3 pt-2">
              <div class="icon icon-lg icon-shape bg-gradient-success shadow-success text-center border-radius-xl mt-n4 position-absolute">
                  <i class="material-icons opacity-10">bar_chart</i> <!-- Icon for Count -->
              </div>
              <div class="text-end pt-1">
                  <p class="text-sm mb-0 text-capitalize">Overall Sales Count</p> <!-- Updated heading -->
                  <h4 class="mb-0"><%= stats.overallSalesCount %></h4>
              </div>
          </div>          
              <hr class="dark horizontal my-0">
              <div class="card-footer p-3">
                  <p class="mb-0"><span class="text-success text-sm font-weight-bolder">+55% </span>than last week</p> <!-- Corrected typo "lask" to "last" -->
              </div>
          </div>
      </div>
      <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
          <div class="card">
              <div class="card-header p-3 pt-2">
                  <div class="icon icon-lg icon-shape bg-gradient-info shadow-info text-center border-radius-xl mt-n4 position-absolute">
                      <i class="material-icons opacity-10">trending_up</i> <!-- Changed icon -->
                  </div>
                  <div class="text-end pt-1">
                      <p class="text-sm mb-0 text-capitalize">Overall Order Amount</p> <!-- Updated heading -->
                      <h4 class="mb-0">₹ <%= stats.overallOrderAmount.toFixed(2) %></h4>
                  </div>
              </div>
              <hr class="dark horizontal my-0">
              <div class="card-footer p-3">
                  <p class="mb-0"><span class="text-success text-sm font-weight-bolder">+3% </span>than last month</p> <!-- Corrected typo "lask" to "last" -->
              </div>
          </div>
      </div>
      <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
          <div class="card">
              <div class="card-header p-3 pt-2">
                  <div class="icon icon-lg icon-shape bg-gradient-warning shadow-warning text-center border-radius-xl mt-n4 position-absolute">
                      <i class="material-icons opacity-10">people</i> <!-- Changed icon -->
                  </div>
                  <div class="text-end pt-1">
                      <p class="text-sm mb-0 text-capitalize">Overall Discount</p> <!-- Updated heading -->
                      <h4 class="mb-0">₹ <%= stats.overallDiscount.toFixed(2) %></h4>
                  </div>
              </div>
              <hr class="dark horizontal my-0">
              <div class="card-footer p-3">
                  <p class="mb-0"><span class="text-danger text-sm font-weight-bolder">-2%</span> than yesterday</p>
              </div>
          </div>
      </div>
      <div class="col-xl-3 col-sm-6">
          <div class="card">
            <div class="card-header p-3 pt-2">
              <div class="icon icon-lg icon-shape bg-gradient-danger shadow-danger text-center border-radius-xl mt-n4 position-absolute">
                  <i class="material-icons opacity-10">attach_money</i> <!-- Icon for Revenue -->
              </div>
              <div class="text-end pt-1">
                  <p class="text-sm mb-0 text-capitalize">Revenue</p>
                  <h4 class="mb-0">₹ <%= stats.overallRevenue %></h4>
              </div>
          </div>
              <hr class="dark horizontal my-0">
              <div class="card-footer p-3">
                  <p class="mb-0"><span class="text-success text-sm font-weight-bolder">+5% </span>than yesterday</p>
              </div>
          </div>
      </div>

<!-- Single Sales Report Graph with Filter -->
<div class="row mt-4">
  <div class="col-lg-12 col-md-12 mt-4 mb-4">
    <div class="card z-index-2">
      <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
        <div id="card-background" class="bg-gradient-primary shadow-primary border-radius-lg py-3 pe-1">
          <div class="d-flex justify-content-between align-items-center">
            <!-- Dynamic Heading -->
            <h6 id="chart-heading" class="mb-0 ms-4 text-white text-center flex-grow-1"> Daily Sales Report</h6>
          </div>
          <div class="chart mt-3">
            <canvas id="sales-chart" class="chart-canvas" height="300"></canvas>
          </div>
        </div>
      </div>
      <div class="card-body" style="position: relative;">
        <!-- Filter Select Box with Inline Styles for Positioning -->
        <select id="sales-filter" 
                style="
                  position: absolute; 
                  top: 10px; 
                  right: 0; 
                  background-color: #e5870c; 
                  border: 1px solid #ced4da; 
                  border-radius: 4px; 
                  padding: 0.375rem 0.75rem; 
                  margin-right: 17px;
                  font-size: 0.875rem; 
                  color:white; 
                  appearance: none; 
                  background-repeat: no-repeat; 
                  background-position: right 0.75rem center; 
                  background-size: 1.5rem 1.5rem; 
                  z-index: 1;
                ">
          <option value="daily">Daily</option>
          <option value="weekly">Weekly</option>
          <option value="monthly">Monthly</option>
          <option value="yearly">Yearly</option>
          <option value="custom">Custom Date</option>
        </select>
        
        <!-- Custom Dates -->
        <div id="custom-dates" class="d-none mt-3">
          <label for="start-date" class="form-label text-white">Start Date</label>
          <input type="date" id="start-date" class="form-control mb-2" />
          <label for="end-date" class="form-label text-white">End Date</label>
          <input type="date" id="end-date" class="form-control mb-2" />
        </div>

        <!-- Update Info -->
        <div class="d-flex align-items-center">
          <i class="material-icons text-sm me-1">schedule</i>
          <p class="mb-0 text-sm">updated just now</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Include Chart.js -->
<script src="/Admin/js/plugins/chartjs.min.js"></script>
<script>
  var ctx = document.getElementById("sales-chart").getContext("2d");
  var salesChart = new Chart(ctx, {
      type: "line",
      data: {
          labels: [],
          datasets: [{
              label: "Sales",
              tension: 0.4,
              borderWidth: 0,
              borderRadius: 4,
              borderSkipped: false,
              backgroundColor: "rgba(255, 255, 255, .8)",
              borderColor: "rgba(255, 255, 255, .8)",
              borderWidth: 4,
              data: [],
              maxBarThickness: 6
          }],
      },
      options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
              legend: {
                  display: false,
              }
          },
          interaction: {
              intersect: false,
              mode: 'index',
          },
          scales: {
              y: {
                  grid: {
                      drawBorder: false,
                      display: true,
                      drawOnChartArea: true,
                      drawTicks: false,
                      borderDash: [5, 5],
                      color: 'rgba(255, 255, 255, .2)'
                  },
                  ticks: {
                      suggestedMin: 0,
                      suggestedMax: 1000,
                      beginAtZero: true,
                      padding: 10,
                      font: {
                          size: 14,
                          weight: 300,
                          family: "Roboto",
                          style: 'normal',
                          lineHeight: 2
                      },
                      color: "#fff"
                  },
              },
              x: {
                  grid: {
                      drawBorder: false,
                      display: true,
                      drawOnChartArea: true,
                      drawTicks: false,
                      borderDash: [5, 5],
                      color: 'rgba(255, 255, 255, .2)'
                  },
                  ticks: {
                      display: true,
                      color: '#f8f9fa',
                      padding: 10,
                      font: {
                          size: 14,
                          weight: 300,
                          family: "Roboto",
                          style: 'normal',
                          lineHeight: 2
                      },
                  }
              },
          },
      },
  });

  async function updateChart(filter) {
      try {
          const startDate = document.getElementById("start-date").value;
          const endDate = document.getElementById("end-date").value;
          const url = `/admin/sales-data-stats?filter=${filter}${filter === 'custom' ? `&startDate=${startDate}&endDate=${endDate}` : ''}`;

          console.log("Fetching URL: ", url);

          const response = await fetch(url);
          const result = await response.json();

          if (!response.ok) {
              throw new Error(result.error || 'Failed to fetch data');
          }

          var cardBackground = document.getElementById("card-background");
          var heading = document.getElementById("chart-heading");

          salesChart.data.labels = result.labels || [];
          salesChart.data.datasets[0].data = result.data || [];

          switch (filter) {
              case "daily":
                  heading.textContent = "Daily Sales Report";
                  cardBackground.className = "bg-gradient-primary shadow-primary border-radius-lg py-3 pe-1";
                  salesChart.data.datasets[0].backgroundColor = "rgba(255, 255, 255, .8)";
                  salesChart.data.datasets[0].borderColor = "rgba(255, 255, 255, .8)";
                  break;
              case "weekly":
                  heading.textContent = "Weekly Sales Report";
                  cardBackground.className = "bg-gradient-secondary shadow-secondary border-radius-lg py-3 pe-1";
                  salesChart.data.datasets[0].backgroundColor = "rgba(0, 0, 255, .8)";
                  salesChart.data.datasets[0].borderColor = "rgba(0, 255, 0, .8)"; // Example color
                  
                  break;
              case "monthly":
                  heading.textContent = "Monthly Sales Report";
                  cardBackground.className = "bg-gradient-warning shadow-warning border-radius-lg py-3 pe-1";
                  salesChart.data.datasets[0].backgroundColor = "rgba(255, 255, 0, .8)"; // Yellow color
              
                  salesChart.data.datasets[0].borderColor = "rgba(0, 0, 255, .8)"; // Example color
                  break;
              case "yearly":
                  heading.textContent = "Yearly Sales Report";
                  cardBackground.className = "bg-gradient-success shadow-success border-radius-lg py-3 pe-1";
                  salesChart.data.datasets[0].backgroundColor = "rgba(0, 255, 0, .8)"; // Example color
                  salesChart.data.datasets[0].borderColor = "rgba(255, 255, 0, .8)"; // Yellow color
                  break;
              case "custom":
                  heading.textContent = "Custom Date Sales Report";
                  cardBackground.className = "bg-gradient-info shadow-info border-radius-lg py-3 pe-1";
                  salesChart.data.datasets[0].backgroundColor = "rgba(0, 255, 255, .8)"; // Example color
                  salesChart.data.datasets[0].borderColor = "rgba(0, 255, 255, .8)"; // Example color
                  break;
              default:
                  heading.textContent = "Daily Sales Report";
                  cardBackground.className = "bg-gradient-primary shadow-primary border-radius-lg py-3 pe-1";
                  salesChart.data.datasets[0].backgroundColor = "rgba(255, 255, 255, .8)";
                  salesChart.data.datasets[0].borderColor = "rgba(255, 255, 255, .8)";
          }

          salesChart.update();
      } catch (error) {
          console.error('Error fetching sales data:', error);
      }
  }

  document.getElementById("sales-filter").addEventListener("change", function() {
      var filter = this.value;
      var customDates = document.getElementById("custom-dates");
      if (filter === "custom") {
          customDates.classList.remove("d-none");
      } else {
          customDates.classList.add("d-none");
      }
      updateChart(filter);
  });

  document.addEventListener("DOMContentLoaded", function() {
      updateChart('daily'); // Set default to 'daily'
  });
</script>

<style>

.border {
  border: 1px solid #ddd; /* Light border color */
}

.rounded {
  border-radius: .375rem; /* Rounded corners */
}

.p-3 {
  padding: 1rem; /* Padding around the content */
}

.bg-light {
  background-color: #f8f9fa; /* Light background color */
}

</style>
<div class="container">
  <div class="row mb-4">
    <!-- Main Content: Sales Report -->
    <div class="col-lg-8 col-md-6 mb-md-0 mb-4">
      <div class="card h-100">
        <div class="card-header pb-0">
          <div class="row">
            <div class="col-lg-6 col-7">
              <h3>Sales Report</h3>
            </div>
            <div class="col-lg-6 col-12 my-auto">
              <div class="d-flex align-items-center justify-content-start border rounded p-3 bg-light">
                <label for="dateFrom" class="form-label text-secondary">From</label>
                <input type="date" id="dateFrom" class="form-control form-control-sm mb-2">
                <label for="dateTill" class="form-label text-secondary">Till</label>
                <input type="date" id="dateTill" class="form-control form-control-sm mb-2">
              </div>
            </div>
            <button type="button" id="getReportButton" class="btn btn-primary btn-sm ms-3" style="width: 110px;">Get Report</button>
          </div>
        </div>
        <div class="card-body px-0 pb-2">
          <div class="table-responsive">
            <table class="table align-items-center mb-0">
              <thead>
                <tr>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-center">Order Id</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-center ps-2">Cx Name</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-center">Payment</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-center">Coupon Discount</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-center">Date</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-center">Total</th>
                </tr>
              </thead>
              <tbody id="salesReportTableBody">
                <!-- Dynamic rows will be inserted here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar or Additional Content -->
    <div class="col-lg-4 col-md-6">
      <div class="card h-100">
        <!-- Transaction Details -->
        <div class="card-body">
          <div class="transaction-details mb-4">
            <h6 class="text-dark font-weight-bold mb-3">Transaction Details</h6>
            <ul class="list-unstyled mb-4" id="transactionDetails">
              <li class="d-flex justify-content-between py-2">
                <span>Total Amount:</span>
                <span id="totalAmount">₹ 0</span>
              </li>
              <li class="d-flex justify-content-between py-2">
                <span>Total Sales:</span>
                <span id="totalSales">0</span>
              </li>
              <li class="d-flex justify-content-between py-2">
                <span>Total Coupon Discount:</span>
                <span id="totalCouponDiscount">₹ 0</span>
              </li>
              <li class="d-flex justify-content-between py-2">
                <span>Total Payment:</span>
                <span id="totalPayment">₹ 0</span>
              </li>
            </ul>
            <!-- Download Report Button -->
            <div class="text-center">
              <button type="button" class="btn btn-primary btn-sm">Download Report</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.getElementById('getReportButton').addEventListener('click', async () => {
  const dateFrom = document.getElementById('dateFrom').value;
  const dateTill = document.getElementById('dateTill').value;

  if (dateFrom && dateTill) {
    try {
      const response = await fetch(`/admin/salesReport?dateFrom=${dateFrom}&dateTill=${dateTill}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        const data = await response.json();
        updateSalesReportTable(data.orders);
        updateTransactionDetails(data.transactionDetails);
      } else {
        console.error('Failed to fetch sales report data');
      }
    } catch (error) {
      console.error('Error fetching sales report data:', error);
    }
  } else {
    alert('Please select both dates');
  }
});

function updateSalesReportTable(orders) {
  const tbody = document.getElementById('salesReportTableBody');
  tbody.innerHTML = ''; // Clear existing table rows

  orders.forEach(order => {
    const row = document.createElement('tr');

    row.innerHTML = `
      <td class="text-center align-middle text-sm"><span class="text-xs font-weight-bold">${order.orderId}</span></td>
      <td class="text-center align-middle text-sm"><span class="text-xs font-weight-bold">${order.deliveryAddress?.name || 'N/A'}</span></td>
      <td class="text-center align-middle text-sm"><span class="text-xs font-weight-bold">$${order.totalAmount}</span></td>
      <td class="text-center align-middle text-sm"><span class="text-xs font-weight-bold">${couponDiscount}%</span></td>
      <td class="text-center align-middle text-sm"><span class="text-xs font-weight-bold">${new Date(order.createdAt).toLocaleDateString()}</span></td>
      <td class="text-center align-middle text-sm"><span class="text-xs font-weight-bold">$${(order.totalAmount - (order.totalAmount * (couponDiscount / 100))).toFixed(2)}</span></td>
    `;

    tbody.appendChild(row);
  });
}

function updateTransactionDetails(details) {
  document.getElementById('totalAmount').innerText = `₹ ${details.totalAmount}`;
  document.getElementById('totalSales').innerText = details.totalSales;
  document.getElementById('totalCouponDiscount').innerText = `₹ ${details.totalCouponDiscount}`;
  document.getElementById('totalPayment').innerText = `₹ ${details.totalPayment}`;
}

</script>

<%- include('../Layouts/adminFooter.ejs') %>